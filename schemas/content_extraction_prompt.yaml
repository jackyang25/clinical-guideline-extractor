schema_name: Clinical Content Logic-Mapping Extraction
schema_version: "3.1"
description: |
  Extracts self-contained clinical content chunks from guideline pages.
  Auto-detects content types and applies appropriate schema.
  Captures decision logic, injects contextual footnotes, and maps navigation points.

role: Senior Clinical Data Architect
task: Decompose guideline pages into logic-complete, RAG-ready clinical chunks

# ==============================================================================
# QUICK REFERENCE - TOP 5 EXTRACTION PRIORITIES
# ==============================================================================

top_priorities:
  1_navigation_vs_clinical:
    rule: "'→ 37' means page 37, not temperature/pressure"
    destination: "exit_points array"
  
  2_complete_branches:
    rule: "Capture BOTH yes and no outcomes"
    why: "Prevents missing 'normal range' guidance"
  
  3_nested_decisions:
    rule: "Use compound AND for multi-step checks"
    example: "'Glucose ≥11.1 AND Ketones present' vs 'AND Ketones absent'"
  
  4_inject_footnotes:
    rule: "Match superscripts to footnotes, inject into implementation_notes"
    avoid: "Creating separate generic chunks"
  
  5_exact_transcription:
    rule: "Copy medical terms, units, dosages exactly"
    critical: "IV≠IM, mmol/L≠mg/dL, <≠≤"

extraction_workflow:
  overview: "Follow this general approach, adapting to actual page content"
  
  step_1_scan:
    action: "Scan entire page including margins, headers, footers"
    identify:
      - Visual formatting (highlighted boxes, flowcharts, tables)
      - Symbol patterns (→, superscripts, comparison operators)
      - Global warnings or exclusions
  
  step_2_identify_content:
    action: "Determine content types present on page"
    approach: "Based on structure and purpose, not just visual appearance"
    multiple: "One page can contain multiple content types"
  
  step_3_extract_structured:
    action: "For each content chunk, apply appropriate schema"
    key_tasks:
      - Map decision logic to pathway_logic with complete branches
      - Match footnotes to chunks and inject into implementation_notes
      - Parse navigation markers into exit_points
      - Extract numeric ranges into range_metadata
      - Transcribe medical information exactly
  
  step_4_verify:
    action: "Check against common errors"
    checklist:
      - No navigation symbols in clinical text
      - All decision branches captured
      - Footnotes injected, not orphaned
      - Medical precision maintained
  
  adaptability: "If page structure differs from expectations, focus on content meaning over visual patterns"

# ==============================================================================
# CORE EXTRACTION PRINCIPLES (Priority-Ordered)
# ==============================================================================

critical_rules:
  title: "Non-negotiable extraction requirements"
  rules:
    1_symbol_disambiguation:
      rule: "Navigation arrows (→ followed by numbers) ALWAYS go to exit_points, never to clinical_criteria"
      why: "Prevents misinterpretation of '→ 37' as temperature/pressure values"
      
    2_complete_logic_branches:
      rule: "Capture BOTH positive AND negative branches of every decision point"
      why: "Prevents silent failures when RAG queries match the negative case"
      
    3_footnote_injection:
      rule: "Inject footnote content into implementation_notes of the relevant chunk"
      why: "Creates self-contained chunks that don't require separate lookups"
      
    4_nested_gate_capture:
      rule: "For multi-step decisions, use compound AND conditions (e.g., 'Glucose ≥ 11.1 AND Ketones present')"
      why: "Captures secondary checks that gate the actual clinical action"
      
    5_exact_transcription:
      rule: "Copy medical terms, dosages, and units exactly as shown"
      why: "IV vs IM, mmol/L vs mg/dL, < vs ≤ are not interchangeable"

core_extraction_strategy:
  approach: "Visual-logical mapping"
  principles:
    - Use ONLY visible text and visual elements from the page
    - Do NOT infer, assume, or add clinical knowledge
    - Treat the page as a structured data source, not a narrative
    - Organize content for retrieval, not reading comprehension
    - Default to capturing more context rather than less
  
  key_behaviors:
    footnotes: "Match superscripts to footnotes and inject text into relevant chunks"
    navigation: "Extract all page references (→ Page X) as structured exit_points"
    negative_paths: "Capture 'no action' or 'routine care' outcomes explicitly"
    global_warnings: "Append page-level exclusions (e.g., 'Not for pregnant women') to ALL chunks on that page"
    prescriber_defaults: "If not stated, infer from context (primary care → nurse, specialist care → doctor)"
    completeness: "Scan entire page including headers, footers, footnotes, and margins"

visual_interpretation_guide:
  description: "Common visual patterns and their meanings (adapt to actual formatting)"
  common_patterns:
    - pattern: "Highlighted boxes (red/pink/yellow/colored backgrounds)"
      likely_meaning: "Emergency content, warnings, or diagnostic criteria"
      action: "Check urgency and select appropriate content_type"
    
    - pattern: "Flowchart with branches (Yes/No, arrows, decision diamonds)"
      likely_meaning: "Clinical pathway with conditional logic"
      action: "Populate pathway_logic for all branches"
    
    - pattern: "Arrows (→) followed by numbers"
      likely_meaning: "Navigation to another page"
      action: "Extract as exit_points, not clinical values"
    
    - pattern: "Superscripts (¹, ², ³, *, †) with matching footer text"
      likely_meaning: "Footnotes with critical context"
      action: "Inject footnote text into implementation_notes"
    
    - pattern: "Bold or emphasized text near numeric values"
      likely_meaning: "Drug names, dosages, or critical thresholds"
      action: "Preserve exactly and populate range_metadata if numeric"
    
    - pattern: "Small text at page bottom or margins"
      likely_meaning: "Global exclusions or general warnings"
      action: "Append to specific_scenario of all chunks on page"
  
  fallback: "If visual formatting is unclear or absent, rely on content structure and keywords"
# ==============================================================================
# SYMBOL INTERPRETATION GUIDE
# ==============================================================================

symbol_translation_guide:
  description: "How to interpret visual symbols and map them to schema fields"
  
  navigation_markers:
    symbols: ["→", "⟲", "↓", ">>", "=>", "See page", "Refer to page"]
    destination_field: "exit_points (with structured condition/target)"
    also_capture_in: "cross_references (as raw marker)"
    
    parsing_logic:
      pattern: "TRIGGER_TEXT [arrow] NUMBER"
      extract_as:
        condition: "TRIGGER_TEXT (the clinical trigger)"
        target: "'page NUMBER'"
      
    examples:
      - input: "Chest pain → 37"
        output: 
          exit_points: [{condition: "Chest pain", target: "page 37"}]
          cross_references: ["→ 37"]
      
      - input: "Decreased consciousness → 16"
        output:
          exit_points: [{condition: "Decreased consciousness", target: "page 16"}]
          cross_references: ["→ 16"]
    
    common_errors_to_avoid:
      - error: "Interpreting '→ 37' as '>37' (comparison)"
        correct: "It's navigation to page 37"
      - error: "Interpreting '→ 37' as '37°C' (temperature)"
        correct: "It's navigation to page 37"
      - error: "Including '→ 37' in clinical_criteria text"
        correct: "Put in exit_points array"
  
  footnote_markers:
    symbols: ["¹", "²", "³", "⁴", "⁵", "⁶", "⁷", "⁸", "⁹", "*", "†", "‡", "§"]
    destination_field: "implementation_notes or safety_checks"
    
    processing_steps:
      1: "Find superscript markers in main content"
      2: "Locate matching footnote text at page bottom"
      3: "Inject full footnote text into relevant chunk"
      4: "Format as 'Footnote 1: [exact text]'"
      5: "Do NOT create separate chunks for footnotes (unless orphaned)"
    
    footnote_content_types:
      preparation: "How to mix/prepare medications (e.g., '¹ Mix 15g sugar in 200mL water')"
      clarification: "Dosing alternatives (e.g., '² If unavailable, dilute 50% solution')"
      definition: "Abbreviations and terms (e.g., '³ BMI = Body Mass Index')"
      safety: "Warnings and contraindications (e.g., '⁴ Avoid in renal impairment')"
    
    example:
      main_text: "Give sugar water¹"
      footnote_text: "¹ Mix 15g sugar (3 teaspoons) in 200mL water"
      extract_to: "implementation_notes: ['Footnote 1: Mix 15g sugar (3 teaspoons) in 200mL water']"
  
  comparison_operators:
    symbols: ["<", ">", "≤", "≥", "="]
    destination_field: "range_metadata (structured numeric ranges)"
    
    extraction_logic:
      detect: "Operator + numeric value + unit"
      parse_as: "{parameter, min_value, max_value, inclusive_min, inclusive_max, unit}"
      
    examples:
      - input: "Glucose < 3 mmol/L"
        output:
          range_metadata:
            - parameter: "glucose"
              min_value: null
              max_value: 3.0
              inclusive_min: true
              inclusive_max: false
              unit: "mmol/L"
      
      - input: "Glucose ≥ 11.1 mmol/L"
        output:
          range_metadata:
            - parameter: "glucose"
              min_value: 11.1
              max_value: null
              inclusive_min: true
              inclusive_max: true
              unit: "mmol/L"
      
      - input: "Temperature 36.5-37.5°C"
        output:
          range_metadata:
            - parameter: "temperature"
              min_value: 36.5
              max_value: 37.5
              inclusive_min: true
              inclusive_max: true
              unit: "°C"
    
    edge_cases:
      mixed_precision: "Use precision as shown (3 vs 3.0 vs 3.00)"
      implicit_ranges: "If no explicit numbers, capture as text in clinical_criteria instead"
      multiple_ranges: "Create separate range_metadata entries for distinct branches"
  
  conditional_keywords:
    keywords: ["If", "Then", "When", "Yes", "No", "AND", "OR", "Check for", "Assess"]
    destination_field: "pathway_logic array"
    
    extraction_approach:
      - "Each complete IF→THEN branch = one pathway_logic entry"
      - "For nested decisions, use compound AND conditions"
      - "Capture both positive AND negative outcomes"
      - "Format as: {if_condition, then_action, next_step}"
    
    nested_logic_example:
      flowchart: "Glucose ≥11.1 → Check ketones → If present: give IV fluids | If absent: monitor"
      extract_as:
        - if_condition: "Glucose ≥ 11.1 AND Ketones present"
          then_action: "Give Sodium Chloride 0.9% IV (staged protocol)"
          next_step: "Monitor for DKA signs"
        - if_condition: "Glucose ≥ 11.1 AND Ketones absent"
          then_action: "Routine monitoring"
          next_step: "Recheck in 24 hours"

# ==============================================================================
# CONTENT TYPE SELECTION
# ==============================================================================

content_type_decision_guide:
  approach: "Select based on primary purpose and structure, not visual appearance alone"
  
  clinical_pathway:
    when_to_use:
      - Content contains conditional logic (IF/THEN, Yes/No branches)
      - Step-by-step protocols with decision points
      - Assessment tables that trigger specific actions
      - Treatment algorithms with multiple pathways
    
    indicators: "Flowcharts, decision trees, branching protocols, 'if...then' language"
    key_feature: "Action depends on patient state/test results"
    
    avoid_for: 
      - Static reference tables without decision logic
      - Pure information without clinical actions
      - Simple lists of danger signs (use warning_signs)
  
  warning_signs:
    when_to_use:
      - Emergency/danger signs requiring immediate action
      - Urgent referral triggers
      - Life-threatening criteria lists
      - Red flag symptoms
    
    indicators: "Red/highlighted boxes, 'emergency', 'danger signs', 'refer immediately'"
    key_feature: "Any sign present → immediate action required"
    
    avoid_for:
      - Protocols with multiple conditional branches (use clinical_pathway)
      - Educational content about recognizing symptoms (use patient_education)
  
  patient_education:
    when_to_use:
      - Instructions for patients/caregivers
      - Home care guidance
      - Prevention and self-care messages
      - "When to return" guidance
      - Medication instructions for patients
    
    indicators: "'Advise patient to...', 'tell caregiver...', 'return if...'"
    key_feature: "Audience is patient/family, not clinician"
    
    avoid_for:
      - Clinical decision-making content (use clinical_pathway)
      - Emergency signs for clinicians (use warning_signs)
  
  reference_table:
    when_to_use:
      - Structured lookup tables
      - Lab reference ranges
      - Age/weight-based vital sign norms
      - Classification or staging systems
      - Dosing charts without detailed instructions
      - Risk calculators or scoring systems
    
    indicators: "Tabular format, rows and columns, systematic classification"
    key_feature: "Look up a value or category, no complex decision logic"
    
    avoid_for:
      - Tables with extensive treatment instructions (use clinical_pathway)
      - Detailed drug information (use drug_monograph)
  
  drug_monograph:
    when_to_use:
      - Comprehensive medication profiles
      - Drug-specific pages with dosing, contraindications, side effects
      - Formulary entries
      - Medication monographs
    
    indicators: "Drug name as heading, organized sections for dosing/contraindications/interactions"
    key_feature: "Primary focus is a single medication"
    
    avoid_for:
      - Brief drug mentions in protocols (keep in clinical_pathway)
      - Simple dosing tables (use reference_table)
  
  generic:
    when_to_use:
      - Background information and epidemiology
      - Definitions and glossaries
      - Page headers/footers
      - Orphaned footnotes with no parent chunk
      - Content that doesn't fit other types
    
    indicators: "Introductory text, context, metadata"
    key_feature: "Informational, not actionable"
    
    note: "Use sparingly - most content should use a specific type"

output_format: JSON array (no markdown wrapper, no commentary)

schema_definitions:
  clinical_pathway:
    content_type:
      type: literal
      value: clinical_pathway
      required: true
    pathway_type:
      type: enum
      meaning: Primary purpose of this pathway
      allowed_values:
        - diagnostic
        - treatment
        - triage
        - screening
        - monitoring
        - mixed
      required: true
    topic:
      type: string
      meaning: The broad clinical subject
      required: true
    specific_scenario:
      type: string
      meaning: The specific patient situation. If global exclusions exist on page (e.g., "Not for pregnant women", "Age < 18 only"), append them here.
      required: true
      example: "Glucose < 3 mmol/L (Excluding pregnant women)"
    range_metadata:
      type: array of objects
      meaning: Explicit numeric ranges for machine filtering
      fields:
        parameter: {type: string, meaning: "What is being measured"}
        min_value: {type: number or null, meaning: "Minimum value (null if unbounded)"}
        max_value: {type: number or null, meaning: "Maximum value (null if unbounded)"}
        inclusive_min: {type: boolean, meaning: "Whether min is inclusive (≥ vs >)"}
        inclusive_max: {type: boolean, meaning: "Whether max is inclusive (≤ vs <)"}
        unit: {type: string, meaning: "Unit (e.g., mmol/L, mmHg)"}
      example:
        - parameter: "glucose"
          min_value: null
          max_value: 3.0
          inclusive_min: true
          inclusive_max: false
          unit: "mmol/L"
    visual_structure:
      type: enum
      meaning: The visual format on the page
      allowed_values:
        - flowchart_path
        - routine_care_table
        - emergency_box
        - general_info
      required: true
    urgency:
      type: enum
      allowed_values: [emergency, urgent, routine]
      required: true
    prescriber_level:
      type: enum
      allowed_values: [nurse, doctor, specialist, patient_self_care, not_applicable]
      required: true
    clinical_criteria:
      type: object
      fields:
        conditions: {type: array of strings}
        emergency_triggers: {type: array of strings}
    protocol:
      type: object
      fields:
        assess: {type: array of strings}
        treat: {type: array of strings}
        advise: {type: array of strings}
    pathway_logic:
      type: array of objects
      meaning: V3.0 - Structured IF/THEN decision logic for clinical reasoning
      instructions: |
        - Capture ALL conditional branches (both positive AND negative paths)
        - Use compound AND conditions to capture nested gates (e.g., "Glucose ≥ 11.1 AND Ketones present")
        - Each distinct clinical scenario should be a separate entry
        - If a secondary test/check acts as a gate, capture it in the if_condition
      fields:
        if_condition: {type: string, meaning: "The clinical state or trigger with ALL required conditions (use AND for gates)"}
        then_action: {type: string, meaning: "The medical action to take"}
        next_step: {type: string, meaning: "What happens next"}
      example:
        - if_condition: "Glucose < 3 and patient alert"
          then_action: "Give 3 teaspoons sugar in 1 cup water"
          next_step: "Recheck glucose after 15 minutes"
        - if_condition: "Glucose < 3 and decreased consciousness"
          then_action: "Give Dextrose 10% 5mL/kg IV"
          next_step: "Emergency protocol -> Page 16"
        - if_condition: "Glucose ≥ 11.1 and symptoms present and ketones present in urine"
          then_action: "Give Sodium Chloride 0.9% 20mL/kg IV over 1 hour"
          next_step: "Check for DKA signs and continue monitoring"
        - if_condition: "Glucose ≥ 11.1 and symptoms present and ketones absent in urine"
          then_action: "Routine monitoring and lifestyle advice"
          next_step: "No immediate intervention required"
    implementation_notes:
      type: array of strings
      meaning: V3.0 - Step-by-step how-to instructions with INJECTED FOOTNOTE CONTENT
      instructions: |
        - Find superscript markers (¹, ², ³) in the text
        - Locate matching footnote at page bottom
        - Inject footnote text here as "Footnote 1: [exact text]"
        - Include drug preparation, dosing calculations, safety warnings
      example:
        - "Footnote 1: Sugar water = 15g sugar (3 teaspoons) in 200mL water"
        - "Footnote 2: If Dextrose 10% unavailable, mix 10mL Dextrose 50% + 40mL water"
        - "Dosing: 5mL/kg IV over 5 minutes"
    exit_points:
      type: array of objects
      meaning: V3.0 - Navigation points where care escalates or transitions
      fields:
        condition: {type: string, meaning: "The trigger that activates this exit"}
        target: {type: string, meaning: "Where to go"}
      example:
        - condition: "Decreased consciousness"
          target: "page 16"
        - condition: "Persistent hypoglycemia after 2 treatments"
          target: "Hospital referral"
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown (e.g., -> 19, 1, -> TB, See page 45)
    disposition:
      type: string
      required: true

  reference_table:
    content_type:
      type: literal
      value: reference_table
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    table_name:
      type: string
      meaning: Name or title of the table
      required: true
    table_purpose:
      type: string
      meaning: What this table is used for
      required: true
    columns:
      type: array of strings
      meaning: Column headers in order
    rows:
      type: array of objects
      meaning: Table data
      fields:
        key: {type: string, meaning: Row identifier}
        values: {type: object, meaning: Column to value mapping}
    units:
      type: object
      meaning: Units for numeric columns
    notes:
      type: array of strings
      meaning: Important caveats or exceptions
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown
    source_reference:
      type: string
      meaning: Citation or source

  drug_monograph:
    content_type:
      type: literal
      value: drug_monograph
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    drug_name:
      type: string
      meaning: Generic drug name
      required: true
    brand_names:
      type: array of strings
    drug_class:
      type: string
    indications:
      type: array of strings
    contraindications:
      type: array of strings
    dosing:
      type: array of objects
      fields:
        route: {type: string}
        dose: {type: string}
        frequency: {type: string}
        duration: {type: string}
        special_populations: {type: string}
    adverse_effects:
      type: array of strings
    drug_interactions:
      type: array of strings
    monitoring:
      type: array of strings
    pregnancy_category:
      type: string
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown
    notes:
      type: array of strings

  generic:
    content_type:
      type: literal
      value: generic
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    section_type:
      type: string
      meaning: Type of content (e.g., background, epidemiology, definitions)
      required: true
    summary:
      type: string
      meaning: Brief 1-2 sentence summary
      required: true
    key_points:
      type: array of strings
      meaning: Main takeaways
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown
    raw_text:
      type: string
      meaning: Preserved original text

  warning_signs:
    content_type:
      type: literal
      value: warning_signs
      required: true
    topic:
      type: string
      meaning: Clinical topic or condition
      required: true
    condition_context:
      type: string
      meaning: The condition these warning signs relate to
    urgency:
      type: enum
      allowed_values: [emergency, urgent]
      required: true
    triggers:
      type: array of strings
      meaning: Clinical signs that activate emergency response
      required: true
    immediate_steps:
      type: array of strings
      meaning: Ordered list of medical actions to perform immediately
      required: true
    safety_checks:
      type: array of strings
      meaning: Specific warnings and contraindications
    referral_required:
      type: boolean
      meaning: Whether referral is required when signs present
    referral_destination:
      type: string
      meaning: Where to refer (e.g., hospital, specialist)
    timeframe:
      type: string
      meaning: How quickly action is needed
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown

  patient_education:
    content_type:
      type: literal
      value: patient_education
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    target_audience:
      type: enum
      allowed_values: [patient, caregiver, both]
      required: true
    education_type:
      type: enum
      allowed_values: [prevention, self_care, when_to_return, medication_instructions, lifestyle, general_information]
      required: true
    key_messages:
      type: array of strings
      meaning: Main education points to communicate
    instructions:
      type: array of strings
      meaning: Step-by-step instructions if applicable
    when_to_seek_care:
      type: array of strings
      meaning: Symptoms or situations requiring return to clinic
    things_to_avoid:
      type: array of strings
      meaning: Actions or substances to avoid
    follow_up:
      type: string
      meaning: Follow-up instructions if specified
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown

# ==============================================================================
# EXTRACTION PATTERNS & EDGE CASES
# ==============================================================================

logic_mapping_patterns:
  complete_decision_trees:
    requirement: "Capture BOTH positive AND negative branches of every decision point"
    rationale: "Prevents RAG from being silent when query matches the negative case"
    
    examples:
      complete:
        - if_condition: "BMI ≥ 25"
          then_action: "Screen for diabetes"
        - if_condition: "BMI < 25"
          then_action: "Routine care - no additional screening"
      
      incomplete:
        - if_condition: "BMI ≥ 25"
          then_action: "Screen for diabetes"
        # Missing: what happens if BMI < 25? (AVOID THIS)
  
  nested_gate_handling:
    pattern: "Primary threshold → Secondary check → Action"
    approach: "Use compound AND conditions to represent the full decision path"
    
    example:
      flowchart: "Glucose ≥11.1 → Check ketones → [If positive: IV fluids] [If negative: monitor]"
      extract_as:
        - if_condition: "Glucose ≥ 11.1 AND Ketones present"
          then_action: "Give IV fluids (staged protocol)"
        - if_condition: "Glucose ≥ 11.1 AND Ketones absent"
          then_action: "Routine monitoring"
      
      avoid: "Skipping the ketone check and going straight to action"
  
  temporal_staging:
    pattern: "Time-dependent dosing or monitoring"
    approach: "Label stages explicitly in implementation_notes"
    
    example:
      - "Stage 1 (First hour): Give Sodium Chloride 0.9% 20mL/kg IV over 1 hour"
      - "Stage 2 (Subsequent hours): Give Sodium Chloride 0.9% 10mL/kg/hour"
      - "Monitoring: Check glucose every 15 minutes for first hour, then hourly"
    
    avoid: "Merging time-staged dosing into single instruction"

range_precision_rules:
  general_principle: "Capture numeric ranges exactly as shown, preserving intentional gaps"
  
  inclusive_operators:
    "≤": "inclusive_max: true"
    "<": "inclusive_max: false"
    "≥": "inclusive_min: true"
    ">": "inclusive_min: false"
  
  unbounded_ranges:
    "< 3": "{min_value: null, max_value: 3.0}"
    "≥ 11.1": "{min_value: 11.1, max_value: null}"
  
  distinct_branches:
    principle: "If guideline shows separate ranges (e.g., 3-6.0, 6.1-11.0, ≥11.1), keep them separate"
    rationale: "Intentional gaps allow precise routing of edge cases like glucose = 6.05"
    avoid: "Smoothing or merging ranges to eliminate gaps"
  
  fallback: "If range is ambiguous or unclear, capture as text in clinical_criteria and omit range_metadata"

edge_case_handling:
  ambiguous_symbols:
    situation: "Unclear if '→ 37' is navigation or clinical value"
    approach: "Default to navigation if pattern is '[text] → [number]' without units"
    
  missing_metadata:
    situation: "Urgency or prescriber_level not explicitly stated"
    approach: "Infer from context (primary care → nurse, specialist → doctor) or use 'not_applicable'"
    
  contradictory_information:
    situation: "Two sections give different dosing"
    approach: "Extract both as separate chunks, add note in implementation_notes flagging discrepancy"
    
  unreadable_sections:
    situation: "OCR errors or poor image quality"
    approach: "Capture what's readable, add note about unclear portions, don't fabricate"
    
  qualitative_criteria:
    situation: "Decision based on 'severe pain' vs 'moderate pain' (no numbers)"
    approach: "Capture as text in if_condition, omit range_metadata"
    
  mixed_content:
    situation: "Page has both flowchart and paragraph text"
    approach: "Create multiple chunks with appropriate types, cross-reference if related"

global_page_context:
  exclusions:
    pattern: "Small text like 'Not for pregnant women' or 'Age < 18 only'"
    handling: "Append to specific_scenario of ALL chunks on that page"
    format: "Original scenario text (Excluding pregnant women)"
  
  continuation_markers:
    pattern: "'Continued from page X' or 'Continued on page Y'"
    handling: "Note in cross_references, consider as context for chunk organization"

output_format_rules:
  structure: "JSON array only - no markdown wrapper, no commentary"
  field_order: "content_type must be first field in each object"
  completeness: "Extract ALL content from page using appropriate schemas"
  system_fields: "Do NOT include chunk_id, guideline_id, or page (added by system)"
  precision: "Copy exact numbers, dosages, units, and medical terms from the image"
  empty_fields: "Keep all schema fields even if empty ([] for arrays, '' for strings, null for optional)"
  cross_references: "Put reference markers in cross_references array, strip from other text fields"
  implementation_notes: "Every chunk with a medical intervention must populate this field"


example:
  - content_type: clinical_pathway
    pathway_type: treatment
    topic: Hyperglycemia Management  
    specific_scenario: Random glucose ≥ 11.1 mmol/L with symptoms
    range_metadata:
      - parameter: "glucose"
        min_value: 11.1
        max_value: null
        inclusive_min: true
        inclusive_max: true
        unit: "mmol/L"
    visual_structure: flowchart_path
    urgency: urgent
    prescriber_level: doctor
    clinical_criteria:
      conditions:
        - Random glucose ≥ 11.1 mmol/L
        - Symptoms of hyperglycemia present
      emergency_triggers:
        - Ketones present in urine (DKA risk)
        - Decreased consciousness
    protocol:
      assess:
        - Check glucose level
        - Check urine for ketones
        - Assess hydration status
      treat:
        - Give IV fluids if ketones present
        - Routine monitoring if ketones absent
      advise:
        - Monitor glucose and ketones
    pathway_logic:
      - if_condition: "Glucose ≥ 11.1 AND Symptoms present AND Ketones present in urine"
        then_action: "Give Sodium Chloride 0.9% IV - staged protocol (see implementation_notes)"
        next_step: "Monitor for DKA signs, check glucose hourly"
      - if_condition: "Glucose ≥ 11.1 AND Symptoms present AND Ketones absent in urine"
        then_action: "Routine monitoring and lifestyle advice"
        next_step: "No emergency intervention - recheck in 24 hours"
      - if_condition: "Glucose ≥ 11.1 AND Decreased consciousness"
        then_action: "Emergency protocol - immediate hospital referral"
        next_step: "Transfer to emergency department"
    implementation_notes:
      - "Footnote 6: Avoid IV insulin in primary care - refer to hospital for insulin protocols"
      - "Stage 1 (First hour): Give Sodium Chloride 0.9% 20mL/kg IV over 1 hour"
      - "Stage 2 (Subsequent hours): Give Sodium Chloride 0.9% 10mL/kg IV per hour until ketones clear"
      - "Ketone testing: Use urine dipstick, check every 2 hours during treatment"
      - "Recheck glucose every 15 minutes for first hour, then hourly"
    exit_points:
      - condition: "Decreased consciousness"
        target: "page 16"
      - condition: "Chest pain develops"
        target: "page 37"
      - condition: "Ketones persist after 4 hours of treatment"
        target: "Hospital referral for insulin therapy"
    cross_references:
      - "-> 16"
      - "-> 37"
      - "6"
    disposition: "Continue treatment until ketones clear, then transition to oral hydration and monitoring"
  - content_type: clinical_pathway
    pathway_type: treatment
    topic: Hypoglycemia Management
    specific_scenario: Random glucose < 3 mmol/L
    range_metadata:
      - parameter: "glucose"
        min_value: null
        max_value: 3.0
        inclusive_min: true
        inclusive_max: false
        unit: "mmol/L"
    visual_structure: flowchart_path
    urgency: emergency
    prescriber_level: doctor
    clinical_criteria:
      conditions:
        - Random glucose < 3 mmol/L
      emergency_triggers:
        - Decreased consciousness
        - Fitting/convulsions
    protocol:
      assess:
        - Check glucose level
        - Assess consciousness level
        - Check for ability to swallow
      treat:
        - Give sugar water if alert
        - Give IV dextrose if unconscious
      advise:
        - Recheck glucose after treatment
    pathway_logic:
      - if_condition: "Glucose < 3 and patient alert and able to swallow"
        then_action: "Give 3 teaspoons sugar in 1 cup water"
        next_step: "Recheck glucose after 15 minutes"
      - if_condition: "Glucose < 3 and decreased consciousness or unable to swallow"
        then_action: "Give Dextrose 10% 5mL/kg IV over 5 minutes"
        next_step: "Emergency protocol -> Page 16"
      - if_condition: "Glucose still < 3 after first treatment"
        then_action: "Repeat treatment and refer to hospital"
        next_step: "Hospital referral"
    implementation_notes:
      - "Footnote 1: Sugar water = 15g sugar (3 teaspoons) in 200mL water (1 cup)"
      - "Footnote 2: If Dextrose 10% unavailable, dilute Dextrose 50% (mix 1 part 50% + 4 parts water for injection)"
      - "Dosing: 5mL/kg IV bolus, give slowly over 5 minutes"
      - "Monitor for signs of dehydration: poor skin turgor, BP < 90/60, pulse > 110"
    exit_points:
      - condition: "Decreased consciousness"
        target: "page 16"
      - condition: "Fitting or convulsions"
        target: "page 19"
      - condition: "Persistent hypoglycemia after 2 treatments"
        target: "Hospital referral"
    cross_references:
      - "-> 16"
      - "-> 19"
      - "1"
      - "2"
    disposition: "Monitor glucose and symptoms, refer if no improvement"
  - content_type: warning_signs
    topic: Severe Malaria
    condition_context: Life-threatening malaria complications
    urgency: emergency
    triggers:
      - Decreased consciousness (GCS < 15)
      - Respiratory distress with tachypnea
      - Multiple convulsions within 24 hours
      - Prostration
      - Severe anemia (Hb < 5 g/dL)
      - Jaundice with renal impairment
    immediate_steps:
      - Administer IV artesunate 2.4 mg/kg immediately
      - Check glucose and give dextrose if < 3 mmol/L
      - Establish IV access and start fluids
      - Refer to hospital emergency department within 1 hour
    safety_checks:
      - Do not give IV fluids rapidly (risk of pulmonary edema)
      - Avoid quinine if patient has taken mefloquine in past 24 hours
      - Monitor glucose hourly (risk of hypoglycemia with severe malaria)
    referral_required: true
    referral_destination: Hospital emergency department with ICU capability
    timeframe: Within 1 hour
    cross_references:
      - "-> 45"
      - "-> 16"
  - content_type: patient_education
    topic: Fever Management
    target_audience: caregiver
    education_type: self_care
    key_messages:
      - Give extra fluids frequently
      - Keep child lightly clothed
      - Give paracetamol for temperature 38.5C or higher
    instructions:
      - Give 10-15mg/kg paracetamol every 4-6 hours if needed
      - Continue breastfeeding or feeding as tolerated
      - Sponge with lukewarm water if temperature very high
    when_to_seek_care:
      - Fever lasts more than 3 days
      - Child refuses to drink
      - Child becomes more unwell
      - Convulsions occur
    things_to_avoid:
      - Do not wrap child in heavy blankets
      - Do not use cold water for sponging
    follow_up: Return in 2 days if fever persists
    cross_references: []
  - content_type: generic
    topic: Glucose Management
    section_type: page_notes
    summary: Orphaned footnotes with no specific parent chunk
    key_points:
      - "5: BMI = Body Mass Index"
      - "6: CVD = Cardiovascular Disease"
    cross_references: []
    raw_text: "Note: Only create generic chunks for orphaned footnotes. Most footnotes should be injected into relevant clinical_pathway or warning_signs chunks via implementation_notes or safety_checks."
  - content_type: clinical_pathway
    pathway_type: diagnostic
    topic: Pneumonia Assessment
    specific_scenario: Child with cough and difficulty breathing
    range_metadata:
      - parameter: "respiratory_rate"
        min_value: 50
        max_value: null
        inclusive_min: true
        inclusive_max: true
        unit: "breaths/min"
    visual_structure: routine_care_table
    urgency: urgent
    prescriber_level: nurse
    clinical_criteria:
      conditions:
        - Fast breathing (RR ≥ 50/min in infants)
        - Chest indrawing
      emergency_triggers: []
    protocol:
      assess:
        - Count respiratory rate for 1 full minute
        - Look for chest indrawing
        - Check for danger signs
      treat:
        - Give first dose Amoxicillin 25mg/kg PO
        - Advise on home care
      advise:
        - Return in 2 days for follow-up or sooner if worsening
    pathway_logic:
      - if_condition: "Respiratory rate ≥ 50/min OR Chest indrawing present"
        then_action: "Diagnose pneumonia - give Amoxicillin"
        next_step: "Home treatment with 2-day follow-up"
      - if_condition: "Respiratory rate < 50/min AND No chest indrawing"
        then_action: "Not pneumonia - symptomatic treatment only"
        next_step: "Advise on when to return"
    implementation_notes:
      - "Dosing: Amoxicillin 25mg/kg PO twice daily for 5 days"
      - "For age < 2 months: use 50 breaths/min cutoff instead"
    exit_points:
      - condition: "Danger signs present"
        target: "page 8"
    cross_references:
      - "-> 8"
    disposition: "Home treatment unless danger signs develop"
  - content_type: reference_table
    topic: Pediatric Vital Signs
    table_name: Normal Respiratory Rate by Age
    table_purpose: Identify tachypnea based on age-specific cutoffs
    columns:
      - Age Group
      - Normal RR (breaths/min)
      - Tachypnea Threshold
    rows:
      - key: "< 2 months"
        values:
          "Age Group": "< 2 months"
          "Normal RR (breaths/min)": "30-60"
          "Tachypnea Threshold": "≥ 60"
      - key: "2-12 months"
        values:
          "Age Group": "2-12 months"
          "Normal RR (breaths/min)": "25-50"
          "Tachypnea Threshold": "≥ 50"
      - key: "1-5 years"
        values:
          "Age Group": "1-5 years"
          "Normal RR (breaths/min)": "20-40"
          "Tachypnea Threshold": "≥ 40"
    units:
      "Normal RR (breaths/min)": "breaths/min"
      "Tachypnea Threshold": "breaths/min"
    notes:
      - "Count for full 60 seconds when child is calm"
      - "Crying or fever can increase respiratory rate"
    cross_references: []
    source_reference: "WHO IMCI guidelines"
  - content_type: drug_monograph
    topic: Pain Management
    drug_name: Paracetamol
    brand_names:
      - Tylenol
      - Panadol
    drug_class: Analgesic-antipyretic
    indications:
      - Mild to moderate pain
      - Fever reduction
    contraindications:
      - Severe liver disease
      - Known hypersensitivity to paracetamol
    dosing:
      - route: PO
        dose: 10-15 mg/kg
        frequency: Every 4-6 hours
        duration: As needed
        special_populations: "Maximum 4 doses in 24 hours"
      - route: IV
        dose: 15 mg/kg
        frequency: Every 6 hours
        duration: As needed
        special_populations: "Use only if PO route unavailable"
    adverse_effects:
      - Rare: skin rash
      - Overdose: hepatotoxicity
    drug_interactions:
      - Warfarin (may potentiate anticoagulant effect)
    monitoring:
      - Monitor liver function if long-term use
    pregnancy_category: Safe in pregnancy at standard doses
    cross_references: []
    notes:
      - "Most common cause of acute liver failure in overdose"
      - "Maximum daily dose: 4g in adults, 75mg/kg in children"

medical_transcription_accuracy:
  critical_distinctions:
    drug_routes: "IM (intramuscular) vs IV (intravenous) vs PO (oral) - NOT interchangeable"
    units: "mmol/L vs mg/dL, mL vs L, mg vs g - preserve exact units"
    operators: "< vs ≤, > vs ≥ - boundary precision matters"
    blood_pressure: "Use forward slash: 90/60 mmHg (not 90-60)"
    terminology: "Watch OCR errors: 'turgor' not 'tumour', 'pallor' not 'paler'"
  
  numeric_precision:
    principle: "Copy numbers exactly as shown"
    examples:
      - shown: "3.0 mmol/L" → extract: "3.0" (not 3)
      - shown: "< 3" → inclusive_max: false
      - shown: "≤ 3" → inclusive_max: true
  
  conditional_logic_splitting:
    avoid: "Combining OR conditions into single pathway_logic entry"
    correct_approach: "Split into separate entries, one for each outcome"
    
    example_incorrect:
      - if_condition: "Glucose < 3 OR Patient unconscious"
        then_action: "Give dextrose"
    
    example_correct:
      - if_condition: "Glucose < 3 AND Patient alert"
        then_action: "Give sugar water orally"
      - if_condition: "Glucose < 3 AND Patient unconscious"
        then_action: "Give Dextrose 10% IV"

# ==============================================================================
# COMMON MISTAKES TO AVOID
# ==============================================================================

common_extraction_errors:
  navigation_symbol_confusion:
    error: "Misinterpreting '→ 37' as a clinical value (temperature, pressure, etc.)"
    correct: "Pattern '[text] → [number]' without units is navigation to page"
    examples:
      - wrong: "clinical_criteria: ['Chest pain 37°C']"
        right: "exit_points: [{condition: 'Chest pain', target: 'page 37'}]"
        source: "Chest pain → 37"
      
      - wrong: "conditions: ['Decreased consciousness > 16']"
        right: "exit_points: [{condition: 'Decreased consciousness', target: 'page 16'}]"
        source: "Decreased consciousness → 16"
  
  incomplete_decision_trees:
    error: "Only capturing positive branch, missing negative outcomes"
    correct: "Every decision point must have entries for both outcomes"
    example:
      wrong:
        - if_condition: "BMI ≥ 25"
          then_action: "Screen for diabetes"
        # What happens if BMI < 25? Missing!
      
      right:
        - if_condition: "BMI ≥ 25"
          then_action: "Screen for diabetes"
        - if_condition: "BMI < 25"
          then_action: "Routine care - no additional screening"
  
  skipped_secondary_gates:
    error: "Missing intermediate checks in nested decision trees"
    correct: "Capture all decision points using compound AND conditions"
    example:
      wrong:
        - if_condition: "Glucose ≥ 11.1"
          then_action: "Give IV fluids"
        # Skips the ketone check!
      
      right:
        - if_condition: "Glucose ≥ 11.1 AND Ketones present"
          then_action: "Give IV fluids (staged protocol)"
        - if_condition: "Glucose ≥ 11.1 AND Ketones absent"
          then_action: "Routine monitoring"
  
  merged_temporal_stages:
    error: "Combining time-dependent dosing into single instruction"
    correct: "Label stages explicitly to prevent dosing errors"
    example:
      wrong: "Give Sodium Chloride 0.9% 20mL/kg IV"
      right:
        - "Stage 1 (First hour): Give Sodium Chloride 0.9% 20mL/kg IV over 1 hour"
        - "Stage 2 (Subsequent hours): Give Sodium Chloride 0.9% 10mL/kg/hour"
  
  range_smoothing:
    error: "Merging distinct ranges that should be separate"
    correct: "Keep ranges separate even if there are gaps"
    example:
      wrong: "range_metadata: [{min: 3.0, max: 11.1}] # Merged!"
      right: "Create 3 separate chunks for 3-6.0, 6.1-11.0, ≥11.1 ranges"
  
  orphaned_footnotes:
    error: "Creating separate generic chunks for all footnotes"
    correct: "Inject footnotes into implementation_notes of relevant chunk"
    example:
      wrong: "generic chunk with all page footnotes"
      right: "Each chunk has relevant footnotes injected in its implementation_notes"

verification_checklist:
  before_finalizing:
    - "Navigation arrows (→) are in exit_points, not clinical_criteria"
    - "Every decision branch has BOTH positive and negative outcomes"
    - "Secondary gates captured with compound AND conditions"
    - "Time-staged dosing labeled with explicit stages"
    - "Range boundaries match visual exactly (no smoothing)"
    - "Footnotes injected into relevant chunks"
    - "Medical terms, units, and dosages copied exactly"
    - "All page content extracted (including headers, footers, margins)"