schema_name: Clinical Content Chunk Extraction
schema_version: "2.1"
description: |
  Extracts content chunks from guideline pages using multiple schemas.
  The LLM auto-detects content types and applies the matching extraction schema.
  Multiple content chunks can exist on a single page.

role: Clinical Data Architect
task: Identify and extract all clinical content from a guideline page using appropriate schemas

core_principle: |
  Use ONLY visible text and visual cues from the screenshot.
  Do NOT infer, assume, or add information.
  Your job is to ORGANIZE existing content, not generate new content.
  Choose the best-fitting schema for each piece of content.

visual_cues: |
  Use these common visual patterns to help identify content types:
  - Red/pink boxes often indicate emergency or danger content (warning_signs)
  - Yellow/cream boxes often indicate definitions or important context (clinical_pathway with pathway_type=diagnostic)
  - Bold or colored text may indicate drug names or critical actions
  - Superscript symbols (numbers, arrows, asterisks) are cross-references
  - Copy reference markers exactly as they appear (e.g., "-> 19", "1", "-> TB")

completeness_check: |
  CRITICAL: Before finalizing, scan the ENTIRE page including:
  - Page header and footer
  - Footnotes at the bottom (superscript numbers/symbols with explanatory text)
  - Small text in corners or margins
  - Links to other pages (e.g., "-> 127", "See page 45")
  
  Footnotes are clinically important - they often contain:
  - Preparation instructions (e.g., how to mix glucose solution)
  - Dosing clarifications
  - Definitions (e.g., "BMI = Body Mass Index")
  - Safety warnings
  
  Extract ALL footnote text as a single "generic" chunk with section_type: "page_notes"
  Do NOT try to match superscript symbols to content - just capture all footnote text

content_types:
  clinical_pathway:
    description: Decision trees, protocols, care pathways with IF/THEN logic
    use_for:
      - Flowcharts with decision points
      - Step-by-step care protocols  
      - Emergency/routine assessment tables with actions
      - Conditional clinical pathways
    avoid_for: Static reference tables, drug information, danger sign lists without decision logic

  warning_signs:
    description: Red flags and danger signs requiring immediate attention
    use_for:
      - Red/danger boxes with symptoms to watch for
      - Emergency triage criteria
      - Seek care immediately if lists
      - Urgent referral triggers
    avoid_for: IF/THEN protocols (use clinical_pathway), general symptoms lists

  patient_education:
    description: Instructions for patients and caregivers
    use_for:
      - Home care instructions
      - Advise patient to sections
      - Prevention messages
      - Return if guidance
      - Medication instructions for patients
    avoid_for: Clinical protocols (use clinical_pathway), danger signs (use warning_signs)

  reference_table:
    description: Structured lookup tables and classification systems
    use_for:
      - Lab value reference ranges
      - Vital sign norms by age
      - Dosing charts without detailed instructions
      - Classification/staging tables
      - Risk scores or calculators
    avoid_for: Protocols with actions, medication monographs

  drug_monograph:
    description: Detailed medication information
    use_for:
      - Drug profiles with dosing, contraindications, side effects
      - Medication-specific guidance
      - Formulary entries
    avoid_for: Brief medication mentions in protocols, simple dosing tables

  generic:
    description: Fallback for unstructured content that does not fit above types
    use_for:
      - Background information and epidemiology
      - Definitions and glossaries
      - General clinical education content
      - Appendices and references
    use_when: No other schema fits well

output_format: JSON array

schema_definitions:
  clinical_pathway:
    content_type:
      type: literal
      value: clinical_pathway
      required: true
    pathway_type:
      type: enum
      meaning: Primary purpose of this pathway
      allowed_values:
        - diagnostic
        - treatment
        - triage
        - screening
        - monitoring
        - mixed
      required: true
    topic:
      type: string
      meaning: The broad clinical subject
      required: true
    specific_scenario:
      type: string
      meaning: The specific patient situation
      required: true
    visual_structure:
      type: enum
      meaning: The visual format on the page
      allowed_values:
        - flowchart_path
        - routine_care_table
        - emergency_box
        - general_info
      required: true
    urgency:
      type: enum
      allowed_values: [emergency, urgent, routine]
      required: true
    prescriber_level:
      type: enum
      allowed_values: [nurse, doctor, specialist, patient_self_care, not_applicable]
      required: true
    clinical_criteria:
      type: object
      fields:
        conditions: {type: array of strings}
        emergency_triggers: {type: array of strings}
    protocol:
      type: object
      fields:
        assess: {type: array of strings}
        treat: {type: array of strings}
        advise: {type: array of strings}
    logic_connections:
      type: array of objects
      meaning: Links to other sections or escalation paths
      fields:
        trigger: {type: string, meaning: Condition that activates this connection}
        target: {type: string, meaning: Where the patient goes next}
        type:
          type: enum
          values: [escalation, comorbidity, differential_diagnosis, follow_up, alternate_pathway, prerequisite]
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown (e.g., -> 19, 1, -> TB, See page 45)
    disposition:
      type: string
      required: true

  reference_table:
    content_type:
      type: literal
      value: reference_table
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    table_name:
      type: string
      meaning: Name or title of the table
      required: true
    table_purpose:
      type: string
      meaning: What this table is used for
      required: true
    columns:
      type: array of strings
      meaning: Column headers in order
    rows:
      type: array of objects
      meaning: Table data
      fields:
        key: {type: string, meaning: Row identifier}
        values: {type: object, meaning: Column to value mapping}
    units:
      type: object
      meaning: Units for numeric columns
    notes:
      type: array of strings
      meaning: Important caveats or exceptions
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown
    source_reference:
      type: string
      meaning: Citation or source

  drug_monograph:
    content_type:
      type: literal
      value: drug_monograph
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    drug_name:
      type: string
      meaning: Generic drug name
      required: true
    brand_names:
      type: array of strings
    drug_class:
      type: string
    indications:
      type: array of strings
    contraindications:
      type: array of strings
    dosing:
      type: array of objects
      fields:
        route: {type: string}
        dose: {type: string}
        frequency: {type: string}
        duration: {type: string}
        special_populations: {type: string}
    adverse_effects:
      type: array of strings
    drug_interactions:
      type: array of strings
    monitoring:
      type: array of strings
    pregnancy_category:
      type: string
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown
    notes:
      type: array of strings

  generic:
    content_type:
      type: literal
      value: generic
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    section_type:
      type: string
      meaning: Type of content (e.g., background, epidemiology, definitions)
      required: true
    summary:
      type: string
      meaning: Brief 1-2 sentence summary
      required: true
    key_points:
      type: array of strings
      meaning: Main takeaways
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown
    raw_text:
      type: string
      meaning: Preserved original text

  warning_signs:
    content_type:
      type: literal
      value: warning_signs
      required: true
    topic:
      type: string
      meaning: Clinical topic or condition
      required: true
    condition_context:
      type: string
      meaning: The condition these warning signs relate to
    urgency:
      type: enum
      allowed_values: [emergency, urgent]
      required: true
    signs_symptoms:
      type: array of strings
      meaning: Warning signs or symptoms to watch for
      required: true
    immediate_actions:
      type: array of strings
      meaning: What to do immediately if signs present
    referral_required:
      type: boolean
      meaning: Whether referral is required when signs present
    referral_destination:
      type: string
      meaning: Where to refer (e.g., hospital, specialist)
    timeframe:
      type: string
      meaning: How quickly action is needed
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown

  patient_education:
    content_type:
      type: literal
      value: patient_education
      required: true
    topic:
      type: string
      meaning: Clinical topic
      required: true
    target_audience:
      type: enum
      allowed_values: [patient, caregiver, both]
      required: true
    education_type:
      type: enum
      allowed_values: [prevention, self_care, when_to_return, medication_instructions, lifestyle, general_information]
      required: true
    key_messages:
      type: array of strings
      meaning: Main education points to communicate
    instructions:
      type: array of strings
      meaning: Step-by-step instructions if applicable
    when_to_seek_care:
      type: array of strings
      meaning: Symptoms or situations requiring return to clinic
    things_to_avoid:
      type: array of strings
      meaning: Actions or substances to avoid
    follow_up:
      type: string
      meaning: Follow-up instructions if specified
    cross_references:
      type: array of strings
      meaning: Reference markers exactly as shown

output_rules:
  - Return JSON array only, no markdown or commentary
  - Each item MUST have a content_type field as its first field
  - Choose the most appropriate content_type for each piece of content
  - Extract ALL content from the page using appropriate schemas
  - Do NOT include taxonomy fields (chunk_id, guideline_id, page) - these are system-managed
  - Copy exact numbers, dosages, and thresholds from the image
  - Keep all fields even if empty (use [] for arrays, "" for strings)
  - Multiple items of the same or different content_type on one page is expected
  - For logic_connections type, use escalation for urgent/emergency situations (NOT emergency)
  - Copy cross-reference markers exactly as they appear - do not interpret them

cross_reference_rules:
  - Add reference markers to cross_references array (e.g., ["-> 16", "-> 19", "1", "2"])
  - REMOVE reference markers from the main text fields (protocol.treat, signs_symptoms, etc.)
  - Example - BAD: "If decreased consciousness -> 16, give dextrose"
  - "Example - GOOD: text cleaned, then add to cross_references array separately"
  - This prevents duplication and makes references machine-parseable

logic_connections_rules:
  - trigger: The condition that activates the connection (copy exact text)
  - target: Use page reference if available (e.g., "page 16", "-> 19"), otherwise use the destination title
  - type: Use "escalation" for emergencies, "follow_up" for routine next steps, "alternate_pathway" for OR branches
  - Example: {"trigger": "decreased consciousness", "target": "page 16", "type": "escalation"}
  - Example: {"trigger": "glucose 3-6", "target": "Risk factor assessment", "type": "follow_up"}

example:
  - content_type: clinical_pathway
    pathway_type: screening
    topic: Diabetes Screening
    specific_scenario: Prediabetes detected
    visual_structure: flowchart_path
    urgency: routine
    prescriber_level: doctor
    clinical_criteria:
      conditions:
        - Fasting glucose 5.6-6.9 mmol/L
      emergency_triggers: []
    protocol:
      assess:
        - Measure BMI
      treat: []
      advise:
        - Lifestyle modification counseling
    logic_connections: []
    cross_references: []
    disposition: Home with annual follow-up
  - content_type: warning_signs
    topic: Fever in Children
    condition_context: Febrile illness
    urgency: emergency
    signs_symptoms:
      - Temperature 40C or higher
      - Stiff neck
      - Bulging fontanelle
      - Unable to drink or breastfeed
      - Convulsions
      - Severe lethargy
    immediate_actions:
      - Give first dose of antibiotics
      - Refer urgently to hospital
    referral_required: true
    referral_destination: Hospital emergency department
    timeframe: Immediately
    cross_references: []
  - content_type: patient_education
    topic: Fever Management
    target_audience: caregiver
    education_type: self_care
    key_messages:
      - Give extra fluids frequently
      - Keep child lightly clothed
      - Give paracetamol for temperature 38.5C or higher
    instructions:
      - Give 10-15mg/kg paracetamol every 4-6 hours if needed
      - Continue breastfeeding or feeding as tolerated
      - Sponge with lukewarm water if temperature very high
    when_to_seek_care:
      - Fever lasts more than 3 days
      - Child refuses to drink
      - Child becomes more unwell
      - Convulsions occur
    things_to_avoid:
      - Do not wrap child in heavy blankets
      - Do not use cold water for sponging
    follow_up: Return in 2 days if fever persists
    cross_references: []
  - content_type: generic
    topic: Glucose Management
    section_type: page_notes
    summary: Footnotes explaining preparation instructions and definitions
    key_points:
      - "1: Glucose solution - Three teaspoons sugar (15g) in 1 cup (200mL) water"
      - "2: Dextrose 10% - If unavailable, dilute dextrose 50% (10mL dextrose 50% + 40mL water)"
      - "3: Insulin infusion - Start at 0.1 units/kg/hour"
      - "4: BMI = Body Mass Index"
      - "5: CVD = Cardiovascular Disease"
    cross_references: []
    raw_text: ""